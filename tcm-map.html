<style>
  #map {
    height: 500px;
    width: 100%;
  }
  #loading, #error {
    background: white;
    padding: 10px 20px;
    margin-bottom: 10px;
    border-radius: 6px;
    font-family: sans-serif;
    box-shadow: 0 0 10px rgba(0,0,0,0.2);
  }
  #error { color: red; display: none; }
</style>

<div id="loading">Loading nearby TCM clinics...</div>
<div id="error"></div>
<div id="map"></div>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCSqqZiFermrGv95UXyp9RDmxxZQXtDcrI&libraries=places&callback=initMap" async defer></script>

<script>
  let map;

  async function initMap() {
    const fallbackLocation = { lat: 1.3521, lng: 103.8198 };
    const userLocation = await getUserLocation().catch(() => fallbackLocation);

    map = new google.maps.Map(document.getElementById("map"), {
      center: userLocation,
      zoom: 14,
    });

    new google.maps.Marker({
      map,
      position: userLocation,
      title: "You are here",
      icon: "https://maps.google.com/mapfiles/ms/icons/blue-dot.png",
    });

    const service = new google.maps.places.PlacesService(map);
    service.nearbySearch(
      {
        location: userLocation,
        radius: 5000,
        keyword: "traditional chinese medicine",
        type: "health",
      },
      (results, status) => {
        document.getElementById("loading").style.display = "none";

        if (status === google.maps.places.PlacesServiceStatus.OK && results.length) {
          const bounds = new google.maps.LatLngBounds();
          let activeInfoWindow = null;

          results.forEach((place) => {
            if (place.geometry && place.geometry.location) {
              const marker = new google.maps.Marker({
                map,
                position: place.geometry.location,
                title: place.name,
              });

              const infowindow = new google.maps.InfoWindow({
                content: `<strong>${place.name}</strong><br>${place.vicinity || ''}`,
              });

              marker.addListener("click", () => {
                if (activeInfoWindow) activeInfoWindow.close();
                infowindow.open(map, marker);
                activeInfoWindow = infowindow;
              });

              bounds.extend(place.geometry.location);
            }
          });

          map.fitBounds(bounds);
        } else {
          const errorMsg = "No nearby TCM clinics found or the Places API request failed.";
          document.getElementById("error").textContent = errorMsg;
          document.getElementById("error").style.display = "block";
        }
      }
    );
  }

  function getUserLocation() {
    return new Promise((resolve, reject) => {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          (position) => {
            resolve({
              lat: position.coords.latitude,
              lng: position.coords.longitude,
            });
          },
          () => reject("Geolocation failed")
        );
      } else {
        reject("Geolocation not supported");
      }
    });
  }

  window.initMap = initMap;
</script>
